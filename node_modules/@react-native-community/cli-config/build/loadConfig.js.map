{"version":3,"names":["getDependencyConfig","root","dependencyName","finalConfig","config","userConfig","isPlatform","merge","name","platforms","Object","keys","reduce","dependency","platform","platformConfig","dependencyConfig","dependencies","loadConfig","projectRoot","findProjectRoot","lazyProject","readConfigFromDisk","initialConfig","reactNativePath","path","resolve","resolveReactNativePath","reactNativeVersion","commands","healthChecks","project","projectConfig","semver","version","current","major","minor","e","UnknownProjectError","Array","from","Set","findDependencies","acc","localDependencyRoot","resolveNodeModuleDir","readDependencyConfigFromDisk","length","assign"],"sources":["../src/loadConfig.ts"],"sourcesContent":["import path from 'path';\nimport {\n  UserDependencyConfig,\n  ProjectConfig,\n  DependencyConfig,\n  UserConfig,\n  Config,\n} from '@react-native-community/cli-types';\nimport {\n  findProjectRoot,\n  version,\n  resolveNodeModuleDir,\n  UnknownProjectError,\n} from '@react-native-community/cli-tools';\nimport findDependencies from './findDependencies';\nimport resolveReactNativePath from './resolveReactNativePath';\nimport {\n  readConfigFromDisk,\n  readDependencyConfigFromDisk,\n} from './readConfigFromDisk';\nimport assign from './assign';\nimport merge from './merge';\n\nfunction getDependencyConfig(\n  root: string,\n  dependencyName: string,\n  finalConfig: Config,\n  config: UserDependencyConfig,\n  userConfig: UserConfig,\n  isPlatform: boolean,\n): DependencyConfig {\n  return merge(\n    {\n      root,\n      name: dependencyName,\n      platforms: Object.keys(finalConfig.platforms).reduce(\n        (dependency, platform) => {\n          const platformConfig = finalConfig.platforms[platform];\n          dependency[platform] =\n            // Linking platforms is not supported\n            isPlatform || !platformConfig\n              ? null\n              : platformConfig.dependencyConfig(\n                  root,\n                  config.dependency.platforms[platform],\n                );\n          return dependency;\n        },\n        {} as Config['platforms'],\n      ),\n    },\n    userConfig.dependencies[dependencyName] || {},\n  ) as DependencyConfig;\n}\n\n/**\n * Loads CLI configuration\n */\nfunction loadConfig(projectRoot: string = findProjectRoot()): Config {\n  let lazyProject: ProjectConfig;\n  const userConfig = readConfigFromDisk(projectRoot);\n\n  const initialConfig: Config = {\n    root: projectRoot,\n    get reactNativePath() {\n      return userConfig.reactNativePath\n        ? path.resolve(projectRoot, userConfig.reactNativePath)\n        : resolveReactNativePath(projectRoot);\n    },\n    reactNativeVersion: 'unknown',\n    dependencies: userConfig.dependencies,\n    commands: userConfig.commands,\n    healthChecks: [],\n    platforms: userConfig.platforms,\n    get project() {\n      if (lazyProject) {\n        return lazyProject;\n      }\n\n      lazyProject = {};\n      for (const platform in finalConfig.platforms) {\n        const platformConfig = finalConfig.platforms[platform];\n        if (platformConfig) {\n          lazyProject[platform] = platformConfig.projectConfig(\n            projectRoot,\n            userConfig.project[platform] || {},\n          );\n        }\n      }\n\n      return lazyProject;\n    },\n  };\n\n  // Try our best to figure out what version of React Native we're running. This is\n  // currently being used to get our deeplinks working, so it's only worried with\n  // the major and minor version.\n  try {\n    let semver = version.current(initialConfig.reactNativePath);\n    if (semver) {\n      // Retain only these version, since they correspond with our documentation.\n      initialConfig.reactNativeVersion = `${semver.major}.${semver.minor}`;\n    }\n  } catch (e) {\n    // If we don't seem to be in a well formed project, give up quietly.\n    if (!(e instanceof UnknownProjectError)) {\n      throw e;\n    }\n  }\n\n  const finalConfig = Array.from(\n    new Set([\n      ...Object.keys(userConfig.dependencies),\n      ...findDependencies(projectRoot),\n    ]),\n  ).reduce((acc: Config, dependencyName) => {\n    const localDependencyRoot =\n      userConfig.dependencies[dependencyName] &&\n      userConfig.dependencies[dependencyName].root;\n\n    try {\n      let root =\n        localDependencyRoot ||\n        resolveNodeModuleDir(projectRoot, dependencyName);\n      let config = readDependencyConfigFromDisk(root, dependencyName);\n\n      const isPlatform = Object.keys(config.platforms).length > 0;\n\n      return assign({}, acc, {\n        dependencies: assign({}, acc.dependencies, {\n          get [dependencyName](): DependencyConfig {\n            return getDependencyConfig(\n              root,\n              dependencyName,\n              finalConfig,\n              config,\n              userConfig,\n              isPlatform,\n            );\n          },\n        }),\n        commands: [...acc.commands, ...config.commands],\n        platforms: {\n          ...acc.platforms,\n          ...config.platforms,\n        },\n        healthChecks: [...acc.healthChecks, ...config.healthChecks],\n      }) as Config;\n    } catch {\n      return acc;\n    }\n  }, initialConfig);\n\n  return finalConfig;\n}\n\nexport default loadConfig;\n"],"mappings":"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"}